<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RK3566 IP-KVM</title>
    <script src="jmuxer.min.js"></script>
    <style>
        body { background: #333; color: #fff; text-align: center; margin: 0; overflow: hidden; font-family: sans-serif; }

        /* 视频容器 */
        #video-container {
            display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw;
        }
        video { border: 1px solid #555; max-width: 100%; max-height: 100%; }

        /* 顶部控制栏 */
        #toolbar {
            position: absolute; top: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100;
        }
        .status-group { font-size: 14px; color: #ccc; }
        .status-ok { color: #0f0; }
        .status-err { color: #f00; }

        button {
            background: #444; color: white; border: 1px solid #666;
            padding: 5px 15px; margin-left: 10px; cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #555; }
        button.active { background: #0078D4; border-color: #005A9E; }
        button.warn { background: #d44; border-color: #a00; }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="status-group">
            Status: <span id="ws-status" class="status-err">Disconnected</span>
        </div>
        <div class="control-group">
            <button id="btn-hid" onclick="toggleHid()">HID: OFF</button>
            <button id="btn-pause" onclick="toggleVideo()">Video: Playing</button>
        </div>
    </div>

    <div id="video-container">
        <video id="player" autoplay muted oncontextmenu="return false;"></video>
    </div>

<script>
    // --- 全局状态 ---
    let isHidEnabled = false; // HID 默认关闭，防止误触
    let isVideoPaused = false;
    let ws = null;
    let jmuxer = new JMuxer({ node: 'player', mode: 'video', flushingTime: 0, fps: 30, debug: false });

    // --- 1. WebSocket 连接管理 ---
    function connectWs() {
        updateStatus("Connecting...", "status-err");

        ws = new WebSocket("ws://" + location.host);
        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
            updateStatus("Connected", "status-ok");
        };

        ws.onclose = () => {
            updateStatus("Disconnected. Retrying in 2s...", "status-err");
            setTimeout(connectWs, 2000);
        };

        ws.onerror = (e) => {
            console.error("WS Error:", e);
            ws.close();
        };

        ws.onmessage = (event) => {
            if (!isVideoPaused) {
                jmuxer.feed({ video: new Uint8Array(event.data) });
            }
        };
    }

    connectWs();

    // --- 2. 界面交互逻辑 ---
    function updateStatus(text, className) {
        const el = document.getElementById('ws-status');
        el.innerText = text;
        el.className = className;
    }

    function toggleHid() {
        isHidEnabled = !isHidEnabled;
        const btn = document.getElementById('btn-hid');
        btn.innerText = "HID: " + (isHidEnabled ? "ON" : "OFF");
        btn.className = isHidEnabled ? "active" : "";
    }

    function toggleVideo() {
        isVideoPaused = !isVideoPaused;
        const btn = document.getElementById('btn-pause');
        if (isVideoPaused) {
            btn.innerText = "Video: Paused";
            btn.className = "warn";
        } else {
            btn.innerText = "Video: Playing";
            btn.className = "";
        }
    }

    // --- 3. HID 辅助数据 ---
    const kLeftCtrl = 1, kLeftShift = 2, kLeftAlt = 4, kLeftSuper = 8;
    const kRightCtrl = 16, kRightShift = 32, kRightAlt = 64, kRightSuper = 128;

    // 完整的 HID 键值映射表 (参考 pro_hidcontroller.cpp)
    const KEY_MAP = {
        // A-Z
        'KeyA': 0x04, 'KeyB': 0x05, 'KeyC': 0x06, 'KeyD': 0x07, 'KeyE': 0x08,
        'KeyF': 0x09, 'KeyG': 0x0A, 'KeyH': 0x0B, 'KeyI': 0x0C, 'KeyJ': 0x0D,
        'KeyK': 0x0E, 'KeyL': 0x0F, 'KeyM': 0x10, 'KeyN': 0x11, 'KeyO': 0x12,
        'KeyP': 0x13, 'KeyQ': 0x14, 'KeyR': 0x15, 'KeyS': 0x16, 'KeyT': 0x17,
        'KeyU': 0x18, 'KeyV': 0x19, 'KeyW': 0x1A, 'KeyX': 0x1B, 'KeyY': 0x1C, 'KeyZ': 0x1D,
        
        // 1-0
        'Digit1': 0x1E, 'Digit2': 0x1F, 'Digit3': 0x20, 'Digit4': 0x21, 'Digit5': 0x22,
        'Digit6': 0x23, 'Digit7': 0x24, 'Digit8': 0x25, 'Digit9': 0x26, 'Digit0': 0x27,
        
        // 功能键
        'Enter': 0x28, 'Escape': 0x29, 'Backspace': 0x2A, 'Tab': 0x2B, 'Space': 0x2C,
        'Minus': 0x2D, 'Equal': 0x2E, 'BracketLeft': 0x2F, 'BracketRight': 0x30,
        'Backslash': 0x31, 'Semicolon': 0x33, 'Quote': 0x34, 'Backquote': 0x35, // ` ~
        'Comma': 0x36, 'Period': 0x37, 'Slash': 0x38, 'CapsLock': 0x39,
        
        // F1-F12
        'F1': 0x3A, 'F2': 0x3B, 'F3': 0x3C, 'F4': 0x3D, 'F5': 0x3E, 'F6': 0x3F,
        'F7': 0x40, 'F8': 0x41, 'F9': 0x42, 'F10': 0x43, 'F11': 0x44, 'F12': 0x45,
        
        // 导航区
        'PrintScreen': 0x46, 'ScrollLock': 0x47, 'Pause': 0x48, 'Insert': 0x49,
        'Home': 0x4A, 'PageUp': 0x4B, 'Delete': 0x4C, 'End': 0x4D, 'PageDown': 0x4E,
        'ArrowRight': 0x4F, 'ArrowLeft': 0x50, 'ArrowDown': 0x51, 'ArrowUp': 0x52,
        
        // 小键盘区 (部分)
        'NumLock': 0x53, 'NumpadDivide': 0x54, 'NumpadMultiply': 0x55, 'NumpadSubtract': 0x56, 'NumpadAdd': 0x57, 'NumpadEnter': 0x58,
        'Numpad1': 0x59, 'Numpad2': 0x5A, 'Numpad3': 0x5B, 'Numpad4': 0x5C, 'Numpad5': 0x5D,
        'Numpad6': 0x5E, 'Numpad7': 0x5F, 'Numpad8': 0x60, 'Numpad9': 0x61, 'Numpad0': 0x62, 'NumpadDecimal': 0x63
    };

    function sendReport(data) {
        if (isHidEnabled && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(new Uint8Array(data));
        }
    }

    function getModifiers(event) {
        let mods = 0;
        if (event.ctrlKey) mods |= kLeftCtrl;
        if (event.shiftKey) mods |= kLeftShift;
        if (event.altKey) mods |= kLeftAlt;
        if (event.metaKey) mods |= kLeftSuper;
        return mods;
    }

    // --- 4. 鼠标事件处理 ---
    const video = document.getElementById('player');

    // 计算 HID 坐标的辅助函数
    function getHidCoords(e) {
        const rect = video.getBoundingClientRect();
        // 计算 0-32767 的绝对坐标 (Web端标准)
        let x = Math.round((e.clientX - rect.left) * 32767 / rect.width);
        let y = Math.round((e.clientY - rect.top) * 32767 / rect.height);

        x = Math.max(0, Math.min(32767, x));
        y = Math.max(0, Math.min(32767, y));
        
        // 返回拆分好的高低位字节
        return {
            xLo: x & 0xFF, xHi: (x >> 8) & 0xFF,
            yLo: y & 0xFF, yHi: (y >> 8) & 0xFF
        };
    }

    // 通用鼠标处理 (整合 按下/松开/移动)
    function handleMouseEvent(e) {
        if (!isHidEnabled || video.videoWidth === 0) return;
        
        // 1. 移动事件特殊过滤：
        // 如果是 mousemove 且 没有任何按键按下 (e.buttons === 0)，则直接忽略。
        // 这样既实现了"平时不跟随"，又实现了"按住能拖拽"。
        if (e.type === 'mousemove' && e.buttons === 0) return;

        // 2. 阻止右键默认菜单
        if (e.button === 2) e.preventDefault(); 

        const coords = getHidCoords(e);
        
        // Protocol: [0x02, Buttons, X_L, X_H, Y_L, Y_H, Wheel]
        const report = [
            0x02, e.buttons, // 这里会自动包含 左键(1)/右键(2)/中键(4) 的组合状态
            coords.xLo, coords.xHi,
            coords.yLo, coords.yHi,
            0 
        ];
        sendReport(report);
    }

    // 滚轮处理
    function handleWheel(e) {
        if (!isHidEnabled || video.videoWidth === 0) return;
        e.preventDefault(); // 阻止浏览器滚动

        const coords = getHidCoords(e);
        
        // 映射滚轮值
        // e.deltaY > 0 是向下滚 -> HID应为 -1 (0xFF)
        // e.deltaY < 0 是向上滚 -> HID应为 1
        let wheel = 0;
        if (e.deltaY < 0) wheel = 1;
        else if (e.deltaY > 0) wheel = 255; // -1 (int8) -> 255 (uint8)

        if (wheel !== 0) {
            const report = [
                0x02, e.buttons, // 保持按键状态，支持按住拖动时滚轮
                coords.xLo, coords.xHi,
                coords.yLo, coords.yHi,
                wheel
            ];
            sendReport(report);
        }
    }

    // 1. 将回调函数改为 handleMouseEvent (你定义的新函数)
    // 2. 必须添加 mousemove 监听，否则 handleMouseEvent 里的拖拽逻辑永远不会触发
    video.addEventListener('mousedown', handleMouseEvent);
    video.addEventListener('mouseup', handleMouseEvent);
    video.addEventListener('mousemove', handleMouseEvent); // <--- 必须加上这一行才能拖拽！
    
    // 其他监听
    video.addEventListener('wheel', handleWheel, { passive: false });
    // 禁用右键菜单
    video.addEventListener('contextmenu', e => e.preventDefault());

    // --- 5. 键盘事件处理 ---
    let keysDown = new Set();

    function handleKey(e, isDown) {
        if (!isHidEnabled) return;

        // 允许 F12 (调试) 和 F5 (刷新)
        if (e.code !== 'F12' && e.code !== 'F5') {
            e.preventDefault();
        }

        // 使用物理按键映射 (event.code)
        const hidCode = KEY_MAP[e.code] || 0;

        // 如果映射不到且没有修饰键，则忽略
        if (hidCode === 0 && !e.ctrlKey && !e.altKey && !e.shiftKey) return;

        if (isDown) keysDown.add(hidCode);
        else keysDown.delete(hidCode);

        // 简单处理：取第一个按下的键发送 (CH9329 基础模式限制)
        let firstKey = 0;
        for (let k of keysDown) { if (k !== 0) { firstKey = k; break; } }

        // Protocol: [0x01, Modifiers, KeyCode]
        const report = [
            0x01,
            getModifiers(e),
            firstKey
        ];
        sendReport(report);
    }

    window.addEventListener('keydown', (e) => handleKey(e, true));
    window.addEventListener('keyup', (e) => handleKey(e, false));

</script>
</body>
</html>
